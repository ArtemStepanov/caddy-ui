# Development Caddyfile for local testing

{
	# Enable admin API
	admin :2019
	
	# Disable automatic HTTPS for local development
	auto_https off
}

# Main orchestrator frontend and API
:2015 {
	# Proxy API requests to backend
	handle /api/* {
		reverse_proxy localhost:3000
	}

	# Serve frontend SPA
	handle {
		root * ./dist
		try_files {path} /index.html
		file_server
	}

	# Enable logging
	log {
		output file ./logs/access.log
		format json
	}
}

# ==========================================
# TEST UPSTREAMS - For development/testing
# ==========================================

# Test: Simple backend service
:8081 {
	reverse_proxy backend-api {
		to localhost:9001
	}
}

# Test: Multiple upstreams with load balancing
:8082 {
	reverse_proxy web-cluster {
		to localhost:9002 localhost:9003 localhost:9004
		
		lb_policy round_robin
		lb_try_duration 5s
	}
}

# Test: Upstreams with active health checks
:8083 {
	reverse_proxy app-servers {
		to localhost:9005 localhost:9006
		
		health_uri /health
		health_interval 10s
		health_timeout 5s
		health_status 200
	}
}

# Test: Upstream with passive health checks
:8084 {
	reverse_proxy database-proxy {
		to localhost:9007 localhost:9008 localhost:9009
		
		lb_policy least_conn
		fail_duration 30s
	}
}

# Test: Mixed healthy/unhealthy scenario (intentionally unreachable)
:8085 {
	reverse_proxy mixed-pool {
		# One likely reachable, others not
		to localhost:3000 localhost:19999 localhost:29999
		
		health_uri /api/health
		health_interval 5s
		lb_try_duration 10s
		lb_try_interval 250ms
	}
}
