name: Pull Request Checks

on:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  pr-metadata:
    name: PR Metadata Check
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
        continue-on-error: true

      - name: PR size label
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/xs'
          xs_max_size: 10
          s_label: 'size/s'
          s_max_size: 100
          m_label: 'size/m'
          m_max_size: 500
          l_label: 'size/l'
          l_max_size: 1000
          xl_label: 'size/xl'
          fail_if_xl: false
        continue-on-error: true

  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      docker: ${{ steps.filter.outputs.docker }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - '**.go'
              - 'go.mod'
              - 'go.sum'
              - 'cmd/**'
              - 'internal/**'
              - 'config/**'
            frontend:
              - 'src/**'
              - 'public/**'
              - '**.ts'
              - '**.tsx'
              - '**.css'
              - 'package.json'
              - 'package-lock.json'
              - 'vite.config.ts'
              - 'tsconfig*.json'
            docker:
              - 'Dockerfile'
              - 'docker-compose*.yml'
              - '.dockerignore'
            docs:
              - '**.md'
              - 'docs/**'

  backend-checks:
    name: Backend Checks
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.2'
          cache: true

      - name: Run go mod verify
        run: go mod verify

      - name: Check for outdated dependencies
        run: go list -u -m all
        continue-on-error: true

  frontend-checks:
    name: Frontend Checks
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Check for lock file conflicts
        run: |
          if git diff origin/${{ github.base_ref }} --name-only | grep -q "package-lock.json"; then
            echo "package-lock.json has changes. Checking for conflicts..."
            npm ci || (echo "::warning::package-lock.json may have conflicts" && exit 1)
          fi

      - name: Install dependencies
        run: npm ci

      - name: Check for outdated dependencies
        run: npm outdated || true
        continue-on-error: true

  comment-coverage:
    name: Comment Test Coverage
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.2'
          cache: true

      - name: Run tests with coverage
        run: |
          # Check if there are any test files
          if find . -name "*_test.go" -type f | grep -q .; then
            go test -v -coverprofile=coverage.out -covermode=atomic ./...
            go tool cover -func=coverage.out > coverage.txt
          else
            echo "No test coverage available yet" > coverage.txt
            echo "No test files found in the project" >> coverage.txt
          fi
        continue-on-error: true

      - name: Comment coverage
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: coverage
          path: coverage.txt
        continue-on-error: true
